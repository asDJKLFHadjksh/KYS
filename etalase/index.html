<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KuhyaKuya Studio</title>
<meta name="description" content="KuhyaKuya Studio – Jasa editing video fleksibel. biaya transparan, order cepat, dan detail kebijakan jelas." />

  <!-- ✅ favicon -->
  <link rel="icon" type="image/svg+xml" href="../img/favicon_v2.svg"> <!-- path updated -->
  <link rel="apple-touch-icon" href="../img/favicon_v2.svg"> <!-- path updated -->

  <link rel="stylesheet" href="../assets/css/theme.css">
  <link rel="stylesheet" href="../assets/css/theme-custom.css">

  <style>
    :root{
      --bg:var(--site-bg); --card:var(--site-surface); --accent:var(--site-accent); --muted:var(--site-muted); --glass: var(--site-glass);
      --gold:#FFD54F; --detail:#555; --flip-duration:250ms; --disabled:#303030;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:var(--site-font);
      background:radial-gradient(circle at top, var(--site-bg-soft), var(--bg));color:var(--site-text);padding:32px;display:flex;justify-content:center;min-height:100vh}
    .container{max-width:1100px;width:100%;padding-bottom:60px;margin:0 auto;position:relative}

    #kodeInput::placeholder{color:rgba(255,255,255,0.65);}

    .site-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;padding-bottom:40px;position:relative;padding-right:140px}
    .header-actions{position:absolute;top:20px;right:20px;display:flex;align-items:center;gap:10px;z-index:1000}
    .brand{display:flex;gap:12px;align-items:center}
    .brand-link{display:flex;align-items:center;gap:12px;color:inherit;text-decoration:none}
    .brand-link:focus-visible{outline:2px solid var(--site-accent-soft);outline-offset:4px;border-radius:10px}
    .logo img{width:44px;height:44px;border-radius:0;object-fit:cover}
    h1{font-size:18px}
    p.lead{color:var(--muted);font-size:13px;margin-top:4px;min-height:16px;transition:opacity .5s ease}
    .btn-cek-status{padding:6px 12px;background:transparent;color:var(--accent);border:2px solid var(--accent);border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;white-space:nowrap;transition:all .2s ease}
    .btn-cek-status:hover{background:var(--accent);color:#fff}
    .btn-cek-status:focus-visible{outline:2px solid var(--site-accent-soft);outline-offset:2px}
    .schedule-indicator{--schedule-color:#4ade80;--schedule-glow:rgba(74,222,128,0.6);position:relative;width:22px;height:22px;padding:0;border:none;background:none;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
    .schedule-indicator.is-closed{--schedule-color:#8A4EFF;--schedule-glow:rgba(86, 0, 255)}
    .schedule-indicator.is-unavailable{--schedule-color:var(--disabled);--schedule-glow:rgba(48,48,48,0.5)}
    .schedule-indicator:focus-visible{outline:2px solid var(--site-accent-soft);outline-offset:4px;border-radius:6px}
    .schedule-indicator .diamond-outer,
    .schedule-indicator .diamond-inner{position:absolute;width:16px;height:16px;transform:rotate(45deg);border-radius:3px}
    .schedule-indicator .diamond-outer{border:2px solid var(--schedule-color);box-shadow:0 0 10px var(--schedule-glow);opacity:0.9}
    .schedule-indicator .diamond-inner{width:10px;height:10px;background:var(--schedule-color);animation:pulseFade 1s ease-in-out infinite}
    .schedule-indicator:hover .diamond-outer{box-shadow:0 0 14px var(--schedule-glow)}
    .schedule-tooltip{position:absolute;bottom:calc(100% + 8px);left:50%;transform:translate(-50%,4px);background:rgba(20,20,20,0.92);color:#fff;padding:4px 8px;border-radius:6px;font-size:11px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .2s ease,transform .2s ease}
    .schedule-indicator:hover .schedule-tooltip,
    .schedule-indicator:focus-visible .schedule-tooltip{opacity:1;transform:translate(-50%,0)}
    .schedule-intro{margin:12px auto 0;max-width:520px;width:fit-content;background:rgba(20,20,20,0.92);color:#fff;border-radius:14px;padding:12px 16px;display:none;align-items:center;gap:14px;box-shadow:0 12px 30px rgba(0,0,0,0.35);text-align:left;border:2px dashed var(--site-accent-soft)}
    .schedule-intro.is-visible{display:flex}
    .schedule-intro .intro-text{font-size:13px;line-height:1.45;color:#f5f5f5}
    .schedule-intro .intro-text span{display:block}
    .schedule-intro .intro-warning{color:#facc15;font-weight:600;margin-bottom:6px;animation:scheduleIntroPulse 1s ease-in-out infinite}
    .schedule-intro .intro-title{font-weight:600;margin-bottom:4px}
    .schedule-intro .intro-legend{display:flex;flex-direction:column;gap:8px;flex-shrink:0}
    .schedule-intro .legend-item{display:flex;align-items:center;gap:8px;font-size:12px;color:#e4e4e4}
    .schedule-intro .legend-diamond{position:relative;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center}
    .schedule-intro .legend-diamond span{position:absolute;width:12px;height:12px;transform:rotate(45deg);border-radius:3px}
    .schedule-intro .legend-diamond .diamond-outline{border:2px solid var(--schedule-color)}
    .schedule-intro .legend-diamond .diamond-fill{width:8px;height:8px;background:var(--schedule-color)}
    .schedule-intro .legend-diamond.is-closed{--schedule-color:#8A4EFF}
    @keyframes scheduleIntroPulse{
      0%,100%{opacity:0.6}
      50%{opacity:1}
    }
    @media (max-width:620px){
      .schedule-intro{margin-top:10px;padding:12px 14px;flex-direction:column;text-align:center;width:min(100%,360px)}
      .schedule-intro .intro-legend{flex-direction:row}
    }
    @keyframes pulseFade{0%,100%{opacity:.55}50%{opacity:1}}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;margin-top:16px}

    /* ===== Portfolio ===== */
    .portfolio-section h2{margin:40px 0 16px;font-size:18px}
    .portfolio-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
    .portfolio-item{
      background:var(--card);
      padding:12px;
      border-radius:12px;
      opacity:0;
      transform:translateY(20px);
      transition:opacity 0.4s ease,transform 0.4s ease;
    }
    .portfolio-item.show{
      opacity:1;
      transform:translateY(0);
    }
    .portfolio-item.hide{
      opacity:0;
      transform:translateY(20px);
      transition:opacity 0.4s ease,transform 0.4s ease;
    }
    .portfolio-item .video-wrapper{position:relative;aspect-ratio:16/9} /* responsive 16:9 */
    .portfolio-item .video-wrapper iframe,
    .portfolio-item .video-wrapper video{position:absolute;top:0;left:0;width:100%;height:100%;border-radius:8px;background:#000;border:none} /* full-size media */
    .portfolio-item .flag{ /* payment status icon */
      width:16px; /* fixed icon width */
      height:16px; /* fixed icon height */
      vertical-align:middle; /* align icon with text */
      margin-right:6px; /* space between icon and text */
      object-fit:contain; /* keep image ratio */
    }
    .portfolio-item .flag.free{filter:brightness(0) invert(1);} /* turn free icon white */
    .portfolio-item .desc{color:var(--muted);margin-top:8px;font-size:14px} /* portfolio text */
    .pkg-highlight{ /* package label badge */
      display:inline-block; /* inline badge */
      background:var(--site-accent-fade); /* light accent background */
      border:1px solid var(--accent); /* accent border */
      color:var(--accent); /* accent text color */
      font-weight:600; /* bold text */
      font-size:0.9em; /* slightly smaller font */
      padding:2px 6px; /* inner spacing */
      border-radius:6px; /* rounded corners */
      margin:0 2px; /* small horizontal gap */
      vertical-align:middle; /* align with text */
    } /* end badge style */
    .portfolio-toggle{display:inline-flex;align-items:center;gap:8px;margin-bottom:12px;cursor:pointer} /* click area for text+diamond */
    .portfolio-toggle .toggle-text{color:var(--accent);text-decoration:underline} /* styled label text */
    .portfolio-toggle .diamond{width:15px;height:15px;border:2px solid var(--accent);transform:rotate(45deg);border-radius:2px;background:transparent} /* diamond indicator */
    .portfolio-toggle.active .diamond{background:var(--accent)} /* fill when active */

    .card{border-radius:12px;overflow:hidden;transition:height .3s ease;position:relative}
    .card-face{background:var(--card);border-radius:12px;padding:18px;
      box-shadow:0 6px 18px rgba(0,0,0,0.6);border:2px solid rgba(255,255,255,0.05);
      transform-origin:center center;transition:transform var(--flip-duration) ease, opacity var(--flip-duration) ease}
    .card-face.hide{display:none}

    .card-front h3{font-size:16px;margin-bottom:4px}
    .price-box{margin:10px 0}
    .old-price{font-size:12px;color:var(--muted);text-decoration:line-through;display:inline-block;margin-right:6px}
    .disc-badge{display:inline-block;background:var(--accent);color:#fff;font-size:11px;padding:2px 6px;border-radius:6px}
    .price{font-weight:700;font-size:20px;margin-top:2px}
    .meta{color:var(--muted);font-size:13px}
    .list{margin:12px 0 16px;padding-left:18px;color:var(--muted);font-size:14px}
    .badge{display:inline-block;background:var(--glass);padding:4px 10px;border-radius:999px;font-size:12px;color:var(--muted);margin-right:6px;margin-top:4px}

    .cta{text-align:right;margin-top:16px}
    .btn{background:var(--accent);color:white;padding:8px 12px;border-radius:10px;font-weight:600;
      cursor:pointer;text-decoration:none;display:inline-block;font-size:13px;border:none}
    .btn.detail{background:var(--detail);color:#fff}
    .btn[disabled]{background:var(--disabled)!important;color:#aaa;cursor:not-allowed;pointer-events:none}

    .card-back h4{margin-bottom:10px;font-size:15px;color:var(--site-text)}
    .card-back h4.policy-title{color:var(--accent)}
    .card-back ul{padding-left:18px;color:var(--muted);margin:0 0 12px}
    .card-back ul:last-of-type{margin-bottom:0}
    .back-btn{margin-top:12px;background:var(--detail);color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:12px}

    footer{position:fixed;bottom:0;left:0;width:100%;background:var(--bg);color:var(--muted);
      font-size:13px;text-align:center;padding:8px 0;z-index:10}
    footer .footer-link{background:none;border:none;color:var(--muted);cursor:pointer;font-size:13px;text-decoration:underline}

    .modal{display:none;position:fixed;z-index:1100;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);align-items:center;justify-content:center;padding:20px}
    .modal.show{display:flex}
    .modal-content{background:var(--card);margin:auto;padding:24px;border-radius:12px;width:100%;max-width:480px;position:relative;
      box-shadow:0 12px 32px rgba(0,0,0,0.45)}
    .modal-content.order-modal{max-width:900px}
    .modal-form{margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .modal-form input{width:250px;padding:6px 10px;background:var(--card);color:#fff;border:1px solid var(--accent);border-radius:6px;outline:none}
    .modal-form button,
    #backupRequestBtn{padding:6px 12px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600}
    .refresh-btn{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border-radius:6px;border:1px solid var(--accent);background:transparent;color:var(--accent);cursor:pointer;font-size:16px;line-height:1;transition:all .2s ease}
    .refresh-btn:hover{background:var(--accent);color:#fff}
    .refresh-btn[disabled]{background:var(--disabled);border-color:var(--disabled);color:#aaa;cursor:not-allowed}
    .modal-content h3{margin-bottom:12px;font-size:18px}
    .modal-content p{margin-bottom:8px;color:var(--muted);font-size:14px}
    .modal-content p strong{color:#fff}
    .modal .close{position:absolute;top:14px;right:18px;background:none;border:none;color:#fff;font-size:24px;cursor:pointer;line-height:1}
    .modal-status{font-weight:700}
    .progress-status{font-weight:700}
    .modal-status.available{color:#4caf50}
    .modal-status.unavailable{color:#f44336}
    #popup-isi{margin-top:16px;font-size:14px}
    #popup-isi p{margin-bottom:8px}
    #popup-isi p:last-child{margin-bottom:0}
    #backupRequestBtn{margin-top:16px;font-size:13px;display:block;text-align:center}
    #backupRequestBtn[disabled],
    #backupRequestBtn.disabled{background:var(--disabled)!important;color:#aaa;cursor:not-allowed;pointer-events:none}
    .order-modal-body{display:flex;gap:20px;margin-top:16px}
    .order-panel{flex:1;min-width:0}
    .order-panel-right{display:none;border-left:1px solid rgba(255,255,255,0.08);padding-left:18px}
    .order-panel-right.visible{display:block}
    .order-detail-head{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    .order-detail-title{font-size:15px;font-weight:700}
    .order-detail-warning{margin-top:12px;padding:10px 12px;border-radius:8px;background:rgba(255,193,7,0.12);color:#ffd54f;font-size:13px;border:1px solid rgba(255,193,7,0.3)}
    .order-detail-row{display:flex;align-items:baseline;justify-content:flex-start;gap:6px;margin-bottom:8px;font-size:14px;color:#EDEDED}
    .order-detail-label{display:flex;align-items:center;gap:8px;color:#EDEDED;font-weight:600}
    .order-detail-dot{width:8px;height:8px;border-radius:999px;display:inline-block;flex:0 0 8px}
    .dot-paket{background:#9BE870}
    .dot-overtime{background:#7AB8FF}
    .dot-deadline{background:#FF8A8A}
    .dot-buffer{background:#FFC47A}
    .dot-revisi{background:#CBB6FF}
    .order-detail-value{font-weight:600}
    .order-detail-note{font-size:12px;color:var(--muted);margin:-2px 0 8px 24px}
    .val-paket{color:#9BE870}
    .val-overtime{color:#7AB8FF}
    .val-deadline{color:#FF8A8A}
    .val-buffer{color:#FFC47A}
    .val-revisi{color:#CBB6FF}
    .order-detail-sum-row{margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.08);justify-content:flex-start}
    .order-detail-sum-label{font-size:12px;color:var(--muted);font-weight:600}
    .order-detail-sum-expression{display:flex;flex-wrap:wrap;gap:6px 8px;font-size:13px;justify-content:flex-start}
    .order-detail-sum-part{font-weight:600}
    .order-detail-sum-operator{color:var(--muted);font-weight:500}
    .order-detail-total{margin-top:12px;padding-top:10px;border-top:1px dashed rgba(255,255,255,0.15);font-weight:700}
    .order-detail-subtotal{margin-top:6px;font-weight:600;font-size:14px;display:flex;align-items:baseline;justify-content:space-between;color:#EDEDED}
    #exportPdfBtn{padding:6px 12px;border-radius:6px;border:none;background:var(--detail);color:#fff;font-weight:600;cursor:pointer;font-size:12px;white-space:nowrap}
    #exportPdfBtn[hidden]{display:none}
    .invoice-print{display:none}

    @media (max-width:820px){
      .order-modal-body{flex-direction:column}
      .order-panel-right{border-left:none;border-top:1px solid rgba(255,255,255,0.08);padding-left:0;padding-top:16px}
    }

    @page{size:A4 portrait;margin:10mm}

    @media print{
      body{margin:0;padding:0;background:#fff}
      body > *:not(#invoice-print){display:none !important}
      #invoice-print{
        display:block;
        position:relative;
        left:auto;
        top:auto;
        width:100%;
        padding:12mm;
        color:#000;
        background:#fff;
      }
      #invoice-print .invoice{
        max-width:180mm;
        margin:0 auto;
        font-size:12pt;
        line-height:1.4;
      }
      #invoice-print h1{font-size:18pt;margin:0 0 8pt}
      #invoice-print p{margin:0 0 4pt}
      #invoice-print hr{margin:8pt 0}
    }

    .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);
      backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;padding:20px;z-index:1000;
      opacity:0;pointer-events:none;transition:opacity .3s ease-out}
    .modal-overlay.show{opacity:1;pointer-events:auto}
    .modal-box{background:var(--card);width:100%;max-width:800px;max-height:90vh;overflow-y:auto;
      border-radius:12px;padding:24px;color:#fff;transform:translateY(20px);transition:transform .3s ease-out;
      scrollbar-width:thin}
    .modal-overlay.show .modal-box{transform:translateY(0)}
    .modal-close{background:var(--detail);color:#fff;border:none;padding:6px 10px;border-radius:8px;
      cursor:pointer;margin-bottom:16px}
    .modal-box h2,.modal-box h3{font-weight:700}
    .modal-box h2{margin-bottom:12px}
    .modal-box h3{margin-top:24px;margin-bottom:8px}
    .modal-box ul{padding-left:20px;margin-bottom:16px}
    .modal-box ul li{margin-bottom:8px}
    .modal-box ul li:last-child{margin-bottom:0}
    .modal-box::-webkit-scrollbar{width:6px}
    .modal-box::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:4px}
    .modal-box::-webkit-scrollbar-thumb{background:var(--detail);border-radius:4px}
    .status-guide{display:flex;flex-direction:column;gap:16px;margin-top:16px}
    .status-item{display:flex;align-items:flex-start;gap:10px}
    .status-item img{height:24px;margin-right:6px}

    .rekom .card-face{border:2px solid var(--gold)!important;box-shadow:0 0 0 1px rgba(255,213,79,.3),0 6px 18px rgba(255,213,79,.25)}
    .ribbon{position:absolute;top:14px;right:14px;background:linear-gradient(135deg,var(--gold),#e6b800);
      color:#2a2200;font-weight:700;padding:4px 8px;border-radius:999px;font-size:11px;z-index:2}

    #popup-jadwal.modal{
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);
      display:flex;justify-content:center;align-items:center;
      z-index:1200;
    }
    #popup-jadwal.modal.tersembunyi{display:none;}
    #popup-jadwal .konten-modal{
      background:#232323;
      padding:28px 32px;
      border-radius:16px;
      color:#fff;
      max-width:480px;
      width:100%;
      position:relative;
      text-align:left;
      box-shadow:0 18px 42px rgba(0,0,0,0.55);
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    #popup-jadwal .modal-heading{
      display:flex;
      flex-direction:column;
      gap:12px;
      padding-right:24px;
    }
    #popup-jadwal .modal-heading h2{
      font-size:22px;
      margin:0;
    }
    #popup-jadwal #tutup-jadwal{
      position:absolute;
      top:18px;
      right:22px;
      background:rgba(255,255,255,0.08);
      border:none;
      color:#fff;
      font-size:20px;
      cursor:pointer;
      width:36px;
      height:36px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:50%;
      transition:background .2s ease;
    }
    #popup-jadwal #tutup-jadwal:hover{
      background:rgba(255,255,255,0.16);
    }
    #popup-jadwal .status-wrapper{
      display:flex;
      align-items:center;
      font-size:22px;
      font-weight:700;
      min-height:28px;
    }
    #popup-jadwal .status-wrapper.status-open{color:#4ade80;}
    #popup-jadwal .status-wrapper.status-closed{color:#8A4EFF;}
    #popup-jadwal .status-wrapper.status-unavailable{color:var(--muted);font-size:16px;font-weight:600;}
    #popup-jadwal .jadwal-section h3{
      margin-bottom:4px;
    }
    #popup-jadwal .jadwal-section{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    #popup-jadwal .jadwal-list{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    #popup-jadwal .jadwal-item{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:20px;
      font-size:17px;
      line-height:1.6;
      padding:10px 16px;
      border-radius:12px;
      background:rgba(255,255,255,0.03);
      transition:background .2s ease,transform .2s ease;
    }
   #popup-jadwal .jadwal-item.hari-ini {
  background: var(--site-accent-fade);       /* latar highlight */
  border: 1px solid var(--accent);  /* garis pinggir */
  box-shadow: 0 8px 22px var(--site-accent-soft); /* efek glow */
}
    #popup-jadwal .jadwal-item.hari-ini .jadwal-hari{color:#fff;}
    #popup-jadwal .jadwal-item.hari-ini .jadwal-jam{color:var(--site-text);}
    #popup-jadwal .jadwal-hari{font-weight:600;}
    #popup-jadwal .jadwal-jam{
      font-weight:600;
      color:var(--muted);
      margin-left:auto;
      text-align:right;
      min-width:120px;
    }
    #popup-jadwal .modal-footer{
      margin-top:auto;
      padding-top:16px;
      border-top:1px solid rgba(255,255,255,0.08);
      display:flex;
      justify-content:flex-end;
    }
    #popup-jadwal #jam-realtime{
      font-size:14px;
      font-weight:600;
      color:var(--muted);
      letter-spacing:0.4px;
    }
    @media (max-width:520px){
      #popup-jadwal .konten-modal{padding:24px 20px;}
      #popup-jadwal .status-wrapper{font-size:18px;}
      #popup-jadwal .jadwal-item{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      #popup-jadwal .jadwal-jam{
        min-width:auto;
        text-align:left;
      }
      #popup-jadwal .modal-footer{
        justify-content:center;
      }
    }
  </style>
</head>
<body>
  <main class="container">
    <header class="site-header">
      <div class="header-actions">
        <button id="scheduleIndicator" type="button" class="schedule-indicator is-unavailable" data-open-schedule aria-label="Jadwal" title="Jadwal">
          <span class="diamond-outer"></span>
          <span class="diamond-inner"></span>
          <span class="schedule-tooltip">Jadwal</span>
        </button>
        <button id="openOrderBtn" type="button" class="btn-cek-status" title="Pantau ketersediaan file dan progres order secara real-time.">Order Tracker</button>
      </div>
      <a class="brand-link" href="../index.html" aria-label="Kembali ke halaman utama">
        <div class="brand">
          <div class="logo"><img src="../img/Logo.png" alt="Logo"></div> <!-- path updated -->
          <div>
            <h1>KuhyaKuya Studio</h1>
            <p class="lead" id="rotating-text">Hasil bisa di lihat di portofolio</p>
          </div>
        </div>
      </a>
    </header>
    <div id="scheduleIntro" class="schedule-intro" role="button" tabindex="0" aria-live="polite">
      <div class="intro-legend" aria-hidden="true">
        <div class="legend-item">
          <span class="legend-diamond" style="--schedule-color:#4ade80;">
            <span class="diamond-outline"></span>
            <span class="diamond-fill"></span>
          </span>
          <span>Buka</span>
        </div>
        <div class="legend-item">
          <span class="legend-diamond is-closed">
            <span class="diamond-outline"></span>
            <span class="diamond-fill"></span>
          </span>
          <span>Tutup</span>
        </div>
      </div>
      <div class="intro-text">
        <span class="intro-warning">⚠️ Panduan singkat — hanya muncul 1x</span>
        <span class="intro-title">Indikator ini adalah tombol jadwal kerja.</span>
        <span>Hijau = Buka, warna merah = Tutup.</span>
        <span>Klik indikator untuk melihat jadwal lengkap.</span>
      </div>
    </div>

    <section class="grid" id="packages"></section>

    <section class="portfolio-section">
      <h2>Portofolio</h2>
        <label id="pfToggle" class="portfolio-toggle" aria-label="Show Portofolio"> <!-- combined text+diamond -->
          <span class="toggle-text">Tampilkan</span> <!-- underlined label text -->
          <span class="diamond"></span> <!-- diamond indicator -->
        </label>
      <div class="portfolio-grid" id="portfolio" style="display:none"></div> <!-- hidden by default -->
    </section>

    <footer><button id="policyBtn" class="footer-link">Kebijakan & Panduan</button></footer>
  </main>

  <div id="orderModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="orderModalTitle">
    <div class="modal-content order-modal">
      <button class="close" type="button" id="orderModalClose" aria-label="Tutup popup">&times;</button>
      <h3 id="orderModalTitle">Order Tracker</h3>
      <div class="modal-form">
        <input id="kodeInput" type="text" placeholder="Input Code Order" autocomplete="off">
        <button id="searchBtn" type="button">Cek Projek Status</button>
        <button id="refreshBtn" type="button" class="refresh-btn" aria-label="Refresh data CSV" title="Refresh data CSV">↻</button>
      </div>
      <div class="order-modal-body">
        <div class="order-panel order-panel-left">
          <div id="popup-isi">
            <p>Masukkan Code Order untuk menampilkan detail.</p>
          </div>
          <button id="backupRequestBtn" type="button" style="display:none">Minta File</button>
        </div>
        <div class="order-panel order-panel-right" id="orderDetailPanel" aria-live="polite">
          <div class="order-detail-head">
            <span class="order-detail-title">Rincian biaya</span>
            <button id="exportPdfBtn" type="button" hidden>Export to PDF</button>
          </div>
          <div id="order-detail-content">
            <p>Rincian harga akan muncul otomatis untuk code baru (KYS).</p>
          </div>
          <div id="order-detail-warning" class="order-detail-warning" hidden>
            ⚠️ Peringatan: biaya pada rincian ini menggunakan konfigurasi harga terbaru, jadi bisa berbeda dari harga saat proyek dinyatakan selesai.
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="invoice-print" class="invoice-print" aria-hidden="true"></div>

  <div id="policyModal" class="modal-overlay" aria-hidden="true">
    <div class="modal-box">
      <button id="modalClose" class="modal-close">Tutup</button>
      <h2>Kebijakan Global</h2>
      <h3>Revisi</h3>
      <ul>
        <li>Revisi minor (typo, glitch, potong scene kecil) gratis x kali sesuai paket.</li>
        <li>Revisi besar (ubah konsep, ganti footage utama, tambah durasi) dihitung biaya tambahan.</li>
        <li>Permintaan revisi di luar jangka waktu yang disepakati akan dianggap proyek baru.</li>
      </ul>
      <h3>Hak untuk Portofolio</h3>
      <ul>
        <li>Editor berhak menampilkan hasil akhir di portofolio sebagai contoh karya.</li>
        <li>Jika klien ingin hasil tidak dipublikasikan, wajib menyampaikan secara tertulis (chat/email) sebelum proyek selesai.</li>
        <li>Tanpa permintaan tertulis, editor berhak menampilkan cuplikan atau highlight.</li>
      </ul>
      <h3>Perjanjian DP (Down Payment)</h3>
      <ul>
        <li>DP minimal 30–50% dari total biaya sebagai tanda jadi dan mem-booking jadwal produksi.</li>
        <li>Proses editing dimulai setelah DP diterima.</li>
        <li>DP tidak dapat dikembalikan bila klien membatalkan proyek sepihak.</li>
      </ul>
      <h3>Pembayaran Tidak Terselesaikan / Klien Kabur</h3>
      <ul>
        <li>Jika sisa pembayaran tidak dilunasi dalam waktu ___ hari setelah hasil final diserahkan,
          editor berhak menahan file final tanpa watermark dan/atau tidak memberikan hak penggunaan.</li>
        <li>Jika setelah tenggat tetap tidak ada pelunasan, editor berhak mempublikasikan kembali hasil karya sebagai portofolio dan menagih sesuai hukum yang berlaku.</li>
      </ul>
      <h3>Backup</h3>
      <ul>
        <li>Editor menyimpan backup project dan file mentah (project file, footage) maksimal ___ bulan setelah proyek selesai.</li>
        <li>Setelah masa itu, editor tidak menjamin ketersediaan file.</li>
        <li>Permintaan backup setelah periode tersebut bisa dikenakan biaya tambahan.</li>
      </ul>
      <h3>Raw File</h3>
      <ul>
        <li>File mentah proyek (contoh: .prproj, .aep, footage asli) tidak termasuk dalam paket standar.</li>
        <li>Jika klien menginginkan file mentah, akan dikenakan biaya tambahan sesuai ukuran dan kompleksitas.</li>
        <li>File mentah hanya diberikan setelah pembayaran penuh diterima.</li>
      </ul>

      <h2>Panduan Simbol Status Proyek</h2>
      <div class="status-guide">
        <div class="status-item">
          <img src="../img/free.png" alt="free icon">
          <div><strong>Free</strong><br>Proyek gratis: bisa berupa paket Gabut, promosi internal, atau proyek tak berbayar.</div>
        </div>
        <div class="status-item">
          <img src="../img/paid.png" alt="paid icon">
          <div><strong>Paid</strong><br>Proyek berbayar yang sudah <strong>lunas</strong>, seluruh pembayaran telah diterima.</div>
        </div>
        <div class="status-item">
          <img src="../img/unpaid.png" alt="unpaid icon">
          <div><strong>Unpaid</strong><br>Pesanan yang <strong>belum dibayar</strong> atau kasus klien yang “kabur”. Video aman sebagai contoh karya, namun tidak boleh digunakan komersial sampai pembayaran diselesaikan.</div>
        </div>
      </div>
  </div>
</div>

  <div id="popup-jadwal" class="modal tersembunyi" aria-hidden="true">
    <div class="konten-modal">
      <button id="tutup-jadwal" aria-label="Tutup jadwal">×</button>
      <div class="modal-heading">
        <h2>Jadwal Kerja</h2>
        <div id="status-jadwal" class="status-wrapper" aria-live="polite"></div>
      </div>
      <div class="jadwal-section">
        <h3>Jadwal Lengkap</h3>
        <ul id="jadwal-lengkap" class="jadwal-list"></ul>
      </div>
      <footer class="modal-footer">
        <p id="jam-realtime" aria-live="polite"></p>
      </footer>
    </div>
  </div>

  <script src="https://unpkg.com/lottie-web/build/player/lottie.min.js"></script>
  <script src="../js/loader.js"></script>
  <script src="/assets/js/schedule.js"></script>
  <script src="../assets/js/order-code.js"></script>
  <script src="../assets/js/pricing.js"></script>
  <script src="/assets/js/portfolio.js"></script>
  <script>
    const texts=[
      "biaya transparan, kerjaan adil. Satu klik untuk hasil terbaik bagi client dan freelancer.",
      "Jam kerja: Kamis–Selasa 19:00–22:00 • Sabtu–Minggu 09:00–22:00"
    ];
    let idx=0; const el=document.getElementById('rotating-text');
    setInterval(()=>{ idx=(idx+1)%texts.length; el.style.opacity=0;
      setTimeout(()=>{ el.textContent=texts[idx]; el.style.opacity=1; },500);
    },5000);

    const FLIP_DURATION=250;

    const CSV_URL="https://docs.google.com/spreadsheets/d/e/2PACX-1vRZiGRgDxVjlJupwCAb29TPzNlksU5kISHLkmfpqbdwO_NQ__PEOk8FxuHe_UwzxWe5pcnfTJ1MFX3b/pub?gid=0&single=true&output=csv";
    const TIME_ZONE="Asia/Jakarta";
    let orderRowsCache=null;
    let orderColumns=null;

    const defaultColumnIndexes={
      title:0,
      statusProgress:1,
      orderDate:2,
      finishDate:3,
      backupExpired:4,
      status:5,
      projectCode:6,
      orderCode:7,
      revision:8
    };

    const statusColorMap={
      'waiting asset':'#ff9800',
      'preparing asset':'#ffc107',
      'rendering':'#2196f3',
      'revision':'#9c27b0',
      'payment':'#4caf50',
      'approved':'#2e7d32',
      'none':'#9e9e9e',
      'kosong':'#9e9e9e',
      '':'#9e9e9e'
    };

    const orderModal=document.getElementById('orderModal');
    const orderModalContent=document.getElementById('popup-isi');
    const orderModalClose=document.getElementById('orderModalClose');
    const kodeInput=document.getElementById('kodeInput');
    const searchBtn=document.getElementById('searchBtn');
    const refreshBtn=document.getElementById('refreshBtn');
    const openOrderBtn=document.getElementById('openOrderBtn');
    const backupRequestBtn=document.getElementById('backupRequestBtn');
    const orderDetailPanel=document.getElementById('orderDetailPanel');
    const orderDetailContent=document.getElementById('order-detail-content');
    const orderDetailWarning=document.getElementById('order-detail-warning');
    const exportPdfBtn=document.getElementById('exportPdfBtn');
    const invoicePrintArea=document.getElementById('invoice-print');
    const defaultOrderMessage='<p>Masukkan Code Order untuk menampilkan detail.</p>';
    const STORAGE_KEY='order_tracker_last_input';

    let lastOrderData=null;
    let lastInvoiceData=null;
    let priceConfigCache=null;
    let promoConfigCache=null;

    function hideBackupRequestButton(){
      if(backupRequestBtn){
        backupRequestBtn.style.display='none';
        backupRequestBtn.disabled=true;
        backupRequestBtn.classList.remove('disabled');
      }
      lastOrderData=null;
    }

    function updateBackupRequestButton(statusProgres,statusFile){
      if(!backupRequestBtn) return;
      const progressValue=String(statusProgres||'').trim();
      const fileValue=String(statusFile||'').trim();
      const canRequestBackup=progressValue==='Approved'&&fileValue==='File Tersedia';
      backupRequestBtn.style.display='block';
      backupRequestBtn.disabled=!canRequestBackup;
      backupRequestBtn.classList.toggle('disabled',!canRequestBackup);
    }

    async function ensurePriceConfig(){
      if(priceConfigCache && promoConfigCache) return {prices:priceConfigCache,promo:promoConfigCache};
      try{
        const data=await Pricing.loadConfig("..");
        priceConfigCache=data.prices||{};
        promoConfigCache=data.promo||{};
      }catch(err){
        console.error('Gagal memuat konfigurasi WhatsApp:',err);
        priceConfigCache={};
        promoConfigCache={};
      }
      return {prices:priceConfigCache,promo:promoConfigCache};
    }

    async function loadOrderRows(options={}){
      const {force=false,cache='default'}=options;
      if(orderRowsCache && !force){
        if(!orderColumns) orderColumns=mapColumns(orderRowsCache[0]||[]);
        return orderRowsCache;
      }
      const response=await fetch(CSV_URL,{cache});
      if(!response.ok) throw new Error(`Gagal memuat CSV: ${response.status}`);
      const text=(await response.text()).trim();
      orderRowsCache=parseCSV(text);
      orderColumns=mapColumns(orderRowsCache[0]||[]);
      return orderRowsCache;
    }

    function parseCSV(text){
      const rows=[];
      let current=[];
      let value='';
      let insideQuotes=false;
      for(let i=0;i<text.length;i++){
        const char=text[i];
        if(char==='"'){
          if(insideQuotes && text[i+1]==='"'){ value+='"'; i++; }
          else{ insideQuotes=!insideQuotes; }
        }else if(char===',' && !insideQuotes){
          current.push(value);
          value='';
        }else if((char==='\n' || char==='\r') && !insideQuotes){
          if(char==='\r' && text[i+1]==='\n') i++;
          current.push(value);
          rows.push(current);
          current=[];
          value='';
        }else{
          value+=char;
        }
      }
      if(value!=='' || current.length){
        current.push(value);
        rows.push(current);
      }
      return rows
        .filter(row=>row.length&&row.some(cell=>cell.trim()!==''))
        .map(row=>row.map(cell=>cell.trim()));
    }

    function mapColumns(headerRow){
      if(!Array.isArray(headerRow)) return null;
      const normalized=headerRow.map(cell=>String(cell||'').trim().toLowerCase());
      const findIndex=name=>normalized.indexOf(name);
      return {
        title:findIndex('judul'),
        statusProgress:findIndex('status progres'),
        orderDate:findIndex('tanggal order'),
        finishDate:findIndex('tanggal selesai'),
        backupExpired:(()=>{
          const expiredIndex=findIndex('expired backup');
          if(expiredIndex!==-1) return expiredIndex;
          return findIndex('backup expired');
        })(),
        status:(()=>{
          const statusFileIndex=findIndex('status file');
          if(statusFileIndex!==-1) return statusFileIndex;
          return findIndex('status');
        })(),
        projectCode:findIndex('code projek'),
        orderCode:findIndex('code order'),
        revision:findIndex('revisi')
      };
    }

    function getColumnIndex(key){
      const mapped=orderColumns?.[key];
      if(typeof mapped==='number' && mapped>=0) return mapped;
      return defaultColumnIndexes[key]??-1;
    }

    function getCellValue(row,key){
      const idx=getColumnIndex(key);
      if(idx<0 || idx>=row.length) return '';
      return String(row[idx]??'').trim();
    }

    function normalizeOrderCode(value){
      return String(value||'')
        .trim()
        .replace(/[\s\r\n]+/g,'')
        .replace(/[\u200B-\u200D\uFEFF]/g,'');
    }

    function parseSheetDate(value){
      const raw=String(value||'').trim();
      if(!raw) return null;
      const isoMatch=raw.match(/^(\d{4})-(\d{1,2})-(\d{1,2})/);
      if(isoMatch){
        const year=parseInt(isoMatch[1],10);
        const month=parseInt(isoMatch[2],10);
        const day=parseInt(isoMatch[3],10);
        return new Date(Date.UTC(year,month-1,day));
      }
      const slashMatch=raw.match(/^(\d{1,2})[\/.-](\d{1,2})[\/.-](\d{4})/);
      if(slashMatch){
        const day=parseInt(slashMatch[1],10);
        const month=parseInt(slashMatch[2],10);
        const year=parseInt(slashMatch[3],10);
        return new Date(Date.UTC(year,month-1,day));
      }
      const parsed=new Date(raw);
      if(Number.isNaN(parsed.getTime())) return null;
      return parsed;
    }

    function parseDecodedOrderDate(value){
      if(value===null || typeof value==='undefined') return null;
      if(typeof value==='number'){
        const ms=value<1e12?value*1000:value;
        const date=new Date(ms);
        if(!Number.isNaN(date.getTime())) return date;
      }
      const text=String(value||'').trim();
      if(!text) return null;
      const parsed=parseSheetDate(text);
      if(parsed) return parsed;
      const fallback=new Date(text);
      if(!Number.isNaN(fallback.getTime())) return fallback;
      return null;
    }

    function formatUiDate(date){
      return new Intl.DateTimeFormat('id-ID',{day:'2-digit',month:'2-digit',year:'numeric'}).format(date);
    }

    function formatTrackerDate(value){
      const raw=String(value||'').trim();
      if(!raw) return '-';
      const compactDigits=raw.replace(/[^\d]/g,'');
      if(compactDigits.length>=12){
        const year=compactDigits.slice(0,4);
        const month=compactDigits.slice(4,6);
        const day=compactDigits.slice(6,8);
        const hour=compactDigits.slice(8,10);
        const minute=compactDigits.slice(10,12);
        const second=compactDigits.length>=14?compactDigits.slice(12,14):'00';
        return `${day}/${month}/${year} ${hour}:${minute}:${second}`;
      }
      if(compactDigits.length===8){
        const year=compactDigits.slice(0,4);
        const month=compactDigits.slice(4,6);
        const day=compactDigits.slice(6,8);
        return `${day}/${month}/${year}`;
      }
      const parsedDate=parseSheetDate(raw);
      if(parsedDate) return formatUiDate(parsedDate);
      return raw;
    }

    function getDateKey(date){
      return new Intl.DateTimeFormat('en-CA',{timeZone:TIME_ZONE}).format(date);
    }

    function resetDetailPanel(){
      if(orderDetailPanel) orderDetailPanel.classList.remove('visible');
      if(orderDetailContent) orderDetailContent.innerHTML='<p>Rincian harga akan muncul otomatis untuk code baru (KYS).</p>';
      if(orderDetailWarning){
        orderDetailWarning.hidden=true;
      }
      if(exportPdfBtn){
        exportPdfBtn.hidden=true;
      }
      lastInvoiceData=null;
    }

    function getProgressColor(status){
      const value=String(status||'').trim();
      if(!value) return statusColorMap.none;
      const lower=value.toLowerCase();
      if(lower.startsWith('ongoing')) return '#fbc02d';
      if(statusColorMap[lower]) return statusColorMap[lower];
      if(lower.includes('none')||lower.includes('kosong')) return statusColorMap.none;
      return statusColorMap.none;
    }

    function formatMinutes(value){
      const minutes=Number(value);
      if(!Number.isFinite(minutes)) return '-';
      return `${minutes} menit`;
    }

    function formatPercent(value){
      const num=Number(value);
      if(!Number.isFinite(num)) return '0';
      return parseFloat(num.toFixed(2)).toString();
    }

    function computeRevisionFee(revisionCount,pkg,subtotal){
      const revisiUsed=parseInt(revisionCount,10)||0;
      const included=Number(pkg?.included_revisions ?? pkg?.revisions ?? 0) || 0;
      const extraCount=Math.max(0,revisiUsed-included);
      const revisionPercent=Number(pkg?.extra_revision_percent)||0;
      const baseAmount=Number(subtotal)||0;
      const fee=extraCount>0 && revisionPercent>0
        ? Math.round(baseAmount*(revisionPercent/100)*extraCount)
        : 0;
      return {revisiUsed,included,extraCount,revisionPercent,fee};
    }

    function updateInvoiceControls(finishDate){
      const todayKey=getDateKey(new Date());
      if(!finishDate){
        if(exportPdfBtn) exportPdfBtn.hidden=true;
        if(orderDetailWarning) orderDetailWarning.hidden=true;
        return;
      }
      const finishKey=getDateKey(finishDate);
      if(exportPdfBtn) exportPdfBtn.hidden=finishKey!==todayKey;
      if(orderDetailWarning) orderDetailWarning.hidden=finishKey>=todayKey;
    }

    function renderInvoice(data){
      if(!invoicePrintArea || !data) return;
      const {rowData,pkg,calc,revisionInfo,totalWithRevision,decoded,subtotalWithoutRevision}=data;
      const durationText=decoded?.duration ? formatMinutes(decoded.duration) : '-';
      const revisionPercentText=formatPercent(revisionInfo?.revisionPercent);
      invoicePrintArea.innerHTML=`
        <div class="invoice">
          <h1>Invoice</h1>
          <p><strong>Judul:</strong> ${escapeHtml(rowData.judul)}</p>
          <p><strong>Code Order:</strong> ${escapeHtml(rowData.codeOrder)}</p>
          <p><strong>Code Projek:</strong> ${escapeHtml(rowData.codeProjek)}</p>
          <p><strong>Tanggal Selesai:</strong> ${escapeHtml(rowData.tanggalSelesai)}</p>
          <hr>
          <p><strong>Paket:</strong> ${escapeHtml(pkg?.name||'-')}</p>
          <p><strong>Durasi:</strong> ${durationText}</p>
          <p><strong>biaya Paket:</strong> ${Pricing.fmtIDR(calc?.baseFinal||0)}</p>
          <p><strong>Biaya 5+:</strong> ${calc?.overMin||0} mnt × ${Pricing.fmtIDR(calc?.overRate||0)} = ${Pricing.fmtIDR(calc?.overCost||0)}</p>
          <p><strong>Deadline Surcharge:</strong> ${Pricing.fmtIDR(calc?.surchargeVal||0)}</p>
          <p><strong>Buffer Fee:</strong> ${Pricing.fmtIDR(calc?.bufVal||0)}</p>
          <p><strong>Subtotal (tanpa revisi):</strong> ${Pricing.fmtIDR(subtotalWithoutRevision||0)}</p>
          <p><strong>Biaya Revisi Tambahan:</strong> ${Pricing.fmtIDR(revisionInfo?.fee||0)} (${revisionPercentText}% × Subtotal ${Pricing.fmtIDR(subtotalWithoutRevision||0)} × ${revisionInfo?.extraCount ?? 0}x)</p>
          <p class="order-detail-total"><strong>Total:</strong> ${Pricing.fmtIDR(totalWithRevision||0)}</p>
        </div>
      `;
    }

    async function renderDetailPanel(decoded,rowData){
      if(!orderDetailPanel || !orderDetailContent) return;
      orderDetailPanel.classList.add('visible');
      const {prices,promo}=await ensurePriceConfig();
      const packages=Array.isArray(prices?.packages)?prices.packages:[];
      const pkg=packages.find(item=>String(item.id)===String(decoded.packageId));
      const durasi=Number(decoded.duration)||0;
      const deadline=Number(decoded.deadline)||0;

      if(!pkg){
        orderDetailContent.innerHTML='<p>Detail paket dari code KYS tidak ditemukan pada konfigurasi harga terbaru.</p>';
        updateInvoiceControls(parseSheetDate(rowData.tanggalSelesai));
        return;
      }

      const calc=Pricing.calcTotal(pkg,prices,promo,durasi,deadline);
      const subtotalWithoutRevision=(Number(calc.baseFinal)||0)
        + (Number(calc.overCost)||0)
        + (Number(calc.surchargeVal)||0)
        + (Number(calc.bufVal)||0);
      const revisionInfo=computeRevisionFee(rowData.revisi,pkg,subtotalWithoutRevision);
      const totalWithRevision=subtotalWithoutRevision+revisionInfo.fee;

      const revisionPercentText=formatPercent(revisionInfo.revisionPercent);

      orderDetailContent.innerHTML=`
        <p><strong>Paket:</strong> ${escapeHtml(pkg.name||'-')} (ID ${escapeHtml(pkg.id)})</p>
        <p><strong>Durasi:</strong> ${formatMinutes(durasi)}</p>
        <p><strong>Deadline:</strong> ${deadline ? `${deadline} hari` : '-'}</p>
        <div class="order-detail-row">
          <span class="order-detail-label"><span class="order-detail-dot dot-paket"></span>biaya Paket:</span>
          <span class="order-detail-value val-paket">${Pricing.fmtIDR(calc.baseFinal)}</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label"><span class="order-detail-dot dot-overtime"></span>Biaya 5+:</span>
          <span class="order-detail-value val-overtime">${calc.overMin} mnt × ${Pricing.fmtIDR(calc.overRate||0)} = ${Pricing.fmtIDR(calc.overCost)}</span>
        </div>
        <div class="order-detail-note">Biaya 5+ dihitung untuk durasi di atas 5 menit.</div>
        <div class="order-detail-row">
          <span class="order-detail-label"><span class="order-detail-dot dot-deadline"></span>Deadline Surcharge:</span>
          <span class="order-detail-value val-deadline">${Pricing.fmtIDR(calc.surchargeVal)}</span>
        </div>
        <div class="order-detail-row">
          <span class="order-detail-label"><span class="order-detail-dot dot-buffer"></span>Buffer Fee:</span>
          <span class="order-detail-value val-buffer">${Pricing.fmtIDR(calc.bufVal)}</span>
        </div>
        <div class="order-detail-row order-detail-sum-row">
          <span class="order-detail-sum-expression">
            <span class="order-detail-sum-part val-paket">${Pricing.fmtIDR(calc.baseFinal)}</span>
            <span class="order-detail-sum-operator">+</span>
            <span class="order-detail-sum-part val-overtime">${Pricing.fmtIDR(calc.overCost)}</span>
            <span class="order-detail-sum-operator">+</span>
            <span class="order-detail-sum-part val-deadline">${Pricing.fmtIDR(calc.surchargeVal)}</span>
            <span class="order-detail-sum-operator">+</span>
            <span class="order-detail-sum-part val-buffer">${Pricing.fmtIDR(calc.bufVal)}</span>
          </span>
        </div>
        <div class="order-detail-subtotal">
          <span>Subtotal (tanpa revisi):</span>
          <span>${Pricing.fmtIDR(subtotalWithoutRevision)}</span>
        </div>
        <p><strong>Revisi:</strong> ${revisionInfo.revisiUsed}x (gratis ${revisionInfo.included}x, tambahan ${revisionInfo.extraCount}x)</p>
        <div class="order-detail-row">
          <span class="order-detail-label"><span class="order-detail-dot dot-revisi"></span>Biaya Revisi Tambahan:</span>
          <span class="order-detail-value val-revisi">${Pricing.fmtIDR(revisionInfo.fee)} (${revisionPercentText}% × Subtotal ${Pricing.fmtIDR(subtotalWithoutRevision)} × ${revisionInfo.extraCount}x)</span>
        </div>
        <div class="order-detail-row order-detail-sum-row">
          <span class="order-detail-sum-expression">
            <span class="order-detail-sum-part">${Pricing.fmtIDR(subtotalWithoutRevision)}</span>
            <span class="order-detail-sum-operator">+</span>
            <span class="order-detail-sum-part val-revisi">${Pricing.fmtIDR(revisionInfo.fee)}</span>
          </span>
        </div>
        <div class="order-detail-total">Total: ${Pricing.fmtIDR(totalWithRevision)}</div>
      `;

      lastInvoiceData={rowData,pkg,calc,revisionInfo,totalWithRevision,decoded,subtotalWithoutRevision};
      updateInvoiceControls(parseSheetDate(rowData.tanggalSelesai));
    }

    function openOrderModal(){
      if(!orderModal) return;
      orderModal.classList.add('show');
      orderModal.setAttribute('aria-hidden','false');
      if(kodeInput) kodeInput.focus();
    }

    function saveOrderInput(){
      if(!kodeInput) return;
      localStorage.setItem(STORAGE_KEY,kodeInput.value.trim());
    }

    function restoreOrderInput(){
      if(!kodeInput) return;
      const lastValue=localStorage.getItem(STORAGE_KEY)||'';
      kodeInput.value=lastValue;
      kodeInput.dispatchEvent(new Event('input',{bubbles:true}));
      kodeInput.dispatchEvent(new Event('change',{bubbles:true}));
    }

    function tutupPopup(){
      if(!orderModal) return;
      orderModal.classList.remove('show');
      orderModal.setAttribute('aria-hidden','true');
      if(openOrderBtn) openOrderBtn.focus();
    }

    function setRefreshLoading(isLoading){
      if(refreshBtn) refreshBtn.disabled=!!isLoading;
      if(typeof window.showLoader==='function' && isLoading){
        window.showLoader();
      }
      if(typeof window.hideLoader==='function' && !isLoading){
        window.hideLoader();
      }
    }

    async function cariData(options={}){
      const {forceRefresh=false}=options;
      const kodeDicari=(kodeInput?.value||'').trim();
      hideBackupRequestButton();
      resetDetailPanel();
      const normalizedInput=normalizeOrderCode(kodeDicari);
      if(!normalizedInput){ alert('Masukkan Code Order dulu'); return; }
      if(orderModalContent){
        orderModalContent.innerHTML='<p>Sedang mencari data...</p>';
      }
      openOrderModal();
      try{
        const rows=await loadOrderRows({
          force:forceRefresh,
          cache:forceRefresh?'no-store':'default'
        });
        const dataRow=rows.slice(1).find(row=>normalizeOrderCode(getCellValue(row,'orderCode'))===normalizedInput);
        if(orderModalContent){
          if(dataRow){
            const rowData={
              judul:getCellValue(dataRow,'title')||'-',
              statusProgres:getCellValue(dataRow,'statusProgress')||'',
              tanggalOrder:formatTrackerDate(getCellValue(dataRow,'orderDate')),
              tanggalSelesai:formatTrackerDate(getCellValue(dataRow,'finishDate')),
              backupExpired:getCellValue(dataRow,'backupExpired')||'-',
              statusFile:getCellValue(dataRow,'status')||'',
              codeProjek:getCellValue(dataRow,'projectCode')||'-',
              codeOrder:getCellValue(dataRow,'orderCode')||'-',
              revisi:parseInt(getCellValue(dataRow,'revision'),10)||0
            };

            let decoded=null;
            if(kodeDicari.startsWith('KYS-') && window.OrderCode?.decodeKYS){
              try{
                decoded=window.OrderCode.decodeKYS(kodeDicari);
              }catch(err){
                console.warn('Decoder KYS gagal:',err);
              }
            }
            const isKysDecoded=!!decoded;
            if(isKysDecoded && decoded?.orderDate){
              const decodedDate=parseDecodedOrderDate(decoded.orderDate);
              rowData.tanggalOrder=decodedDate?formatUiDate(decodedDate):String(decoded.orderDate);
            }

            const progressColor=getProgressColor(rowData.statusProgres);
            const progressValue=rowData.statusProgres||'None';
            const progressMarkup=`<p><strong>Status Progres:</strong> <span class="progress-status" style="color:${progressColor};">${escapeHtml(progressValue)}</span></p>`;

            const statusFileRaw=rowData.statusFile||'';
            const statusFileNormalized=statusFileRaw.trim().toLowerCase();
            const statusFileDisplay=statusFileRaw||'None';
            let fileStatusStyle='font-weight:bold';
            if(statusFileNormalized==='file tersedia') fileStatusStyle='color:#4CAF50;font-weight:bold';
            else if(statusFileNormalized==='file tidak tersedia') fileStatusStyle='color:#F44336;font-weight:bold';

            let html='';
            html+=`<p><strong>Judul:</strong> ${escapeHtml(rowData.judul)}</p>`;
            html+=progressMarkup;
            html+=`<p><strong>Tanggal Order:</strong> ${escapeHtml(rowData.tanggalOrder)}</p>`;
            html+=`<p><strong>Tanggal Selesai:</strong> ${escapeHtml(rowData.tanggalSelesai)}</p>`;
            html+=`<p><strong>Backup Expired:</strong> ${escapeHtml(rowData.backupExpired)}</p>`;
            html+=`<p><strong>Status File:</strong> <span class="modal-status" style="${fileStatusStyle}">${escapeHtml(statusFileDisplay)}</span></p>`;
            html+=`<p><strong>Code Projek:</strong> ${escapeHtml(rowData.codeProjek)}</p>`;
            if(!isKysDecoded){
              html+=`<p><strong>Code Order:</strong> ${escapeHtml(rowData.codeOrder)}</p>`;
            }
            html+=`<p><strong>Revisi:</strong> ${rowData.revisi}</p>`;

            orderModalContent.innerHTML=html;
            lastOrderData=rowData;
            updateBackupRequestButton(rowData.statusProgres,rowData.statusFile);

            if(isKysDecoded){
              await renderDetailPanel(decoded,rowData);
            }else{
              resetDetailPanel();
            }
          }else{
            orderModalContent.innerHTML='<p>Code Order tidak ditemukan silahkan konfirmasi ke Freelancer.</p>';
            hideBackupRequestButton();
            resetDetailPanel();
          }
        }
      }catch(error){
        console.error('Error fetching order data:',error);
        if(orderModalContent){
          orderModalContent.innerHTML='<p>Terjadi kesalahan saat memuat data. Silakan coba lagi.</p>';
        }
        hideBackupRequestButton();
        resetDetailPanel();
      }
    }

    async function refreshCurrentOrder(){
      const kodeDicari=(kodeInput?.value||'').trim();
      if(!kodeDicari){
        alert('Masukkan Code Order dulu');
        return;
      }
      setRefreshLoading(true);
      try{
        await cariData({forceRefresh:true});
      }finally{
        setRefreshLoading(false);
      }
    }

    async function handleBackupRequestClick(){
      if(!backupRequestBtn || backupRequestBtn.disabled) return;
      if(!lastOrderData) return;
      const {prices}=await ensurePriceConfig();
      const rawNumber=String(prices?.whatsapp||'').trim();
      const templateRaw=String(prices?.backup_request_message||'').trim();
      if(!rawNumber || !templateRaw){
        alert('Konfigurasi WhatsApp belum tersedia.');
        return;
      }
      const sanitizedNumber=rawNumber.replace(/[^\d]/g,'');
      if(!sanitizedNumber){
        alert('Nomor WhatsApp tidak valid.');
        return;
      }
      const judul=lastOrderData.judul||'-';
      const codeProjek=lastOrderData.codeProjek||'-';
      const codeOrder=lastOrderData.codeOrder||'-';
      let messageTemplate=templateRaw.replace(/%0A/gi,'\n');
      let message=messageTemplate
        .replace(/{{\s*judul\s*}}/gi,judul)
        .replace(/{{\s*code_projek\s*}}/gi,codeProjek)
        .replace(/{{\s*code_order\s*}}/gi,codeOrder);
      const encodedMessage=encodeURIComponent(message);
      const waUrl=`https://wa.me/${sanitizedNumber}?text=${encodedMessage}`;
      window.open(waUrl,'_blank','noopener');
    }

    if(openOrderBtn) openOrderBtn.addEventListener('click',()=>{
      if(orderModalContent) orderModalContent.innerHTML=defaultOrderMessage;
      restoreOrderInput();
      hideBackupRequestButton();
      resetDetailPanel();
      openOrderModal();
    });
    if(searchBtn) searchBtn.addEventListener('click',()=>{
      saveOrderInput();
      cariData();
    });
    if(refreshBtn) refreshBtn.addEventListener('click',()=>{
      saveOrderInput();
      refreshCurrentOrder();
    });
    if(kodeInput) kodeInput.addEventListener('keyup',e=>{ if(e.key==='Enter') cariData(); });
    if(kodeInput) kodeInput.addEventListener('input',saveOrderInput);
    if(orderModalClose) orderModalClose.addEventListener('click',tutupPopup);
    if(orderModal) orderModal.addEventListener('click',e=>{ if(e.target===orderModal) tutupPopup(); });
    document.addEventListener('keydown',e=>{ if(e.key==='Escape'&&orderModal?.classList.contains('show')) tutupPopup(); });
    if(backupRequestBtn) backupRequestBtn.addEventListener('click',handleBackupRequestClick);
    if(exportPdfBtn) exportPdfBtn.addEventListener('click',()=>{
      if(!lastInvoiceData) return;
      renderInvoice(lastInvoiceData);
      window.print();
    });

    async function loadPackages(){
      try{
        const {prices,promo}=await Pricing.loadConfig("..");
        if(prices) priceConfigCache=prices;
        if(promo) promoConfigCache=promo;
        renderPackages(prices.packages,promo);
      }
      catch(e){ console.error("Load config error:",e); }
    }

    function renderPackages(packages,promo){
      const container=document.getElementById('packages');
      container.innerHTML='';
      packages.forEach(pkg=>{
        const {normal,percent,final}=Pricing.getFinalPrice(pkg,promo);
        const isRekom=checkRekom(promo,pkg.id);
        const wrapper=document.createElement('div');
        wrapper.className='card-wrapper';
        wrapper.innerHTML=`
          <div class="card${isRekom?' rekom':''}">
            <div class="card-face card-front">
              ${isRekom?'<div class="ribbon">Rekomendasi</div>':''}
              <h3>${escapeHtml(pkg.name)}</h3>
              <div class="meta">Gratis Revisi: ${pkg.revisions} • Durasi biaya Tetap: ${pkg.durationText} • Deadline: ${pkg.leadTime}</div>
              <div class="price-box">
                ${percent>0?`<span class="old-price">IDR ${numberWithSeparators(normal)}</span><span class="disc-badge">-${percent}%</span>`:''}
                <div class="price">IDR ${numberWithSeparators(final)}</div>
              </div>
              <ul class="list">${(pkg.features||[]).map(f=>`<li>${escapeHtml(f)}</li>`).join('')}</ul>
              <div>${(pkg.tags||[]).map(t=>`<span class="badge">${escapeHtml(t)}</span>`).join('')}</div>
              <div class="cta">
                ${pkg.disabled
                  ? `<a class="btn" disabled>KOUTA HABIS</a>`
                  : `<a class="btn" href="../order.html?id=${pkg.id}">Buat Pesanan</a>`}
                <button class="btn detail flip-btn" type="button">Detail</button>
              </div>
            </div>
            <div class="card-face card-back hide">
              <h4 class="detail-title">Rincian Tambahan Biaya</h4>
              <ul>
                <li>Biaya 5+: + ${Pricing.fmtIDR(Pricing.calcOverRatePerMin(pkg))} / menit</li>
                <li>Biaya 5+ dihitung untuk durasi di atas 5 menit.</li>
                <li>Revisi: Gratis ${Number(pkg.revisions||0)}x</li>
                <li>Revisi tambahan: +${Number(pkg.extra_revision_percent||0)}% dari subtotal / revisi</li>
              </ul>
              <h4 class="policy-title">Kebijakan Paket</h4>
              <ul>${(pkg.policy||["Tidak ada kebijakan tambahan"]).map(p=>`<li>${escapeHtml(p)}</li>`).join('')}</ul>
              <button class="back-btn">← Kembali</button>
            </div>
          </div>`;
        const front=wrapper.querySelector('.card-front');
        const back=wrapper.querySelector('.card-back');
        function flip(fromEl,toEl){
          fromEl.style.transform='scaleX(1)';toEl.style.transform='scaleX(0)';
          fromEl.style.opacity=1;toEl.style.opacity=0;
          fromEl.style.transition=`transform ${FLIP_DURATION}ms ease,opacity ${FLIP_DURATION}ms ease`;
          toEl.style.transition=`transform ${FLIP_DURATION}ms ease,opacity ${FLIP_DURATION}ms ease`;
          fromEl.style.transform='scaleX(0)';fromEl.style.opacity=0;
          setTimeout(()=>{
            fromEl.classList.add('hide');toEl.classList.remove('hide');
            toEl.style.transform='scaleX(0)';toEl.style.opacity=0;
            requestAnimationFrame(()=>{toEl.style.transform='scaleX(1)';toEl.style.opacity=1;});
          },FLIP_DURATION);
        }
        wrapper.querySelector('.flip-btn').addEventListener('click',()=>flip(front,back));
        wrapper.querySelector('.back-btn').addEventListener('click',()=>flip(back,front));
        container.appendChild(wrapper);
      });
    }

    function checkRekom(promo,id){
      if(!promo||!promo.recommended) return false;
      if(Array.isArray(promo.recommended)) return promo.recommended.map(String).includes(String(id));
      return String(promo.recommended)===String(id);
    }
    function numberWithSeparators(x){return x?.toString().replace(/\B(?=(\d{3})+(?!\d))/g,',')||'0'}
    function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}
    loadPackages();
    Portfolio.loadAndRender("/");
      const pfToggle=document.getElementById('pfToggle'); // get toggle label
      const pfGrid=document.getElementById('portfolio'); // get portfolio list
      pfToggle.addEventListener('click',()=>{ // attach click handler
        const hidden=pfGrid.style.display==='none'; // determine state
        if(hidden){
          pfGrid.style.display='';
          pfToggle.classList.toggle('active',true); // toggle diamond fill
          Portfolio.loadAndRender("/");
        }else{
          pfToggle.classList.toggle('active',false); // toggle diamond fill
          Portfolio.hide();
        }
      }); // end handler

    const policyBtn=document.getElementById('policyBtn');
    const policyModal=document.getElementById('policyModal');
    const modalClose=document.getElementById('modalClose');
    function closeModal(){ policyModal.classList.remove('show'); document.body.style.overflow=''; }
    policyBtn.addEventListener('click',()=>{ policyModal.classList.add('show'); document.body.style.overflow='hidden'; });
    modalClose.addEventListener('click',closeModal);
    policyModal.addEventListener('click',e=>{ if(e.target===policyModal) closeModal(); });
  </script>
</body>
</html>
